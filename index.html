<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calculadora de Domicilio - Armenia Quindío</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #e3f2fd; margin: 0; padding: 0; display:flex; flex-direction:column; align-items:center;}
header { width:100%; background:#0d47a1; color:white; text-align:center; padding:16px 0 12px 0;}
main { background:#fff; border-radius:10px; box-shadow:0 2px 12px rgba(13,71,161,0.12); padding:17px 18px; width:355px; margin-top:17px; text-align:center;}
label { font-weight:bold; color:#0d47a1; margin:8px 0 5px 0; display:block; text-align:left;}
input[type="text"] { width:100%; padding:9px 10px; border:2px solid #1976d2; border-radius:6px; margin-bottom:12px; font-size:1rem; background:#f4fbff; color:#144d8e;}
button { width:100%; background:#1976d2; color:white; border:none; border-radius:8px; padding:12px; font-size:1.08rem; font-weight:bold; cursor:pointer; margin-bottom:10px; transition:background 0.3s;}
button:hover { background:#0d47a1; }
#map { width:355px; height:220px; border-radius:10px; margin:10px 0 10px 0; }
#resultado { background:#e3f2fd; color:#0d47a1; font-weight:bold; font-size:1.11rem; padding:12px; border-radius:7px; margin-top:10px; min-height:20px;}
#error { background: #fbe9e7; color:#b71c1c; border-radius:7px; margin-top:6px; font-weight:bold; font-size:1rem; padding:7px; min-height:18px;}
</style>
</head>
<body>
<header>
  <h1>Calculadora de Precios de Domicilio</h1>
  <div>Armenia, Quindío, Colombia</div>
</header>
<main>
  <label for="destino">Dirección o barrio de destino</label>
  <input type="text" id="destino" placeholder="Escribe dirección o barrio" autocomplete="off" />
  <button id="calcularBtn">Calcular precio</button>
  <div id="map"></div>
  <div id="resultado"></div>
  <div id="error"></div>
</main>
<script>
const LIMITES = {norte: 4.5915, sur: 4.5133, este: -75.5948, oeste: -75.681};
let map, marcadorOrigen, marcadorDestino, userLatLng;

// Chequea si una coordenada está dentro de Armenia
function dentroArmenia(lat, lng) {
  return lat <= LIMITES.norte && lat >= LIMITES.sur && lng >= LIMITES.oeste && lng <= LIMITES.este;
}
function mostrarError(msg) {
  document.getElementById('resultado').textContent = "";
  document.getElementById('error').textContent = msg;
}
function limpiarError() { document.getElementById('error').textContent = ""; }
function mostrarResultado(msg) { document.getElementById('resultado').innerHTML = msg; }
function limpiarResultado() { document.getElementById('resultado').textContent = ''; }
function calcularDistancia(origen, destino) {
  const R = 6378137;
  const dLat = (destino.lat - origen.lat) * Math.PI / 180;
  const dLng = (destino.lng - origen.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(origen.lat * Math.PI / 180) * Math.cos(destino.lat * Math.PI / 180) *
    Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function calcularPrecio(d) {
  if (d <= 700) return 5000;
  if (d > 700 && d <= 2500) return 6000;
  if (d > 2500 && d <= 6000) return 7000;
  if (d > 6000 && d <= 8000) return 8000;
  return null;
}
function iniciarMapa(lat, lng) {
  map = L.map('map').setView([lat, lng], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);
  marcadorOrigen = L.marker([lat, lng]).addTo(map).bindPopup("Tu ubicación").openPopup();
}

document.addEventListener("DOMContentLoaded", function() {
  limpiarResultado(); limpiarError();
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      if (!dentroArmenia(lat, lng)) {
        mostrarError('Tu ubicación no está dentro de Armenia, Quindío.');
        document.getElementById('calcularBtn').disabled = true;
        return;
      }
      userLatLng = {lat, lng};
      iniciarMapa(lat, lng);
    }, function(error) {
      let msg = "No se pudo obtener tu ubicación.";
      if (error.code === 1) msg = "Se denegó el permiso para usar la ubicación.";
      mostrarError(msg + " No se puede calcular el domicilio.");
      document.getElementById('calcularBtn').disabled = true;
    }, {enableHighAccuracy: true, timeout: 10000});
  } else {
    mostrarError("Este navegador no soporta geolocalización.");
    document.getElementById('calcularBtn').disabled = true;
  }

  document.getElementById('calcularBtn').onclick = async function() {
    limpiarResultado(); limpiarError();
    if (!userLatLng) {
      mostrarError("Primero es necesario obtener tu ubicación.");
      return;
    }
    const texto = document.getElementById('destino').value.trim();
    if (!texto) {
      mostrarError("Por favor escribe la dirección o barrio de destino.");
      return;
    }

    const query = encodeURIComponent(texto + ', Armenia, Quindío, Colombia');
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${query}`;
    try {
      const resp = await fetch(url, {headers:{"Accept-Language":"es"}});
      const data = await resp.json();
      if (data && data[0]) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        if (!dentroArmenia(lat, lon)) {
          mostrarError("La dirección destino está fuera de Armenia, Quindío.");
          return;
        }
        const destinoLatLng = {lat: lat, lng: lon};
        const distancia = calcularDistancia(userLatLng, destinoLatLng);
        const precio = calcularPrecio(distancia);
        if (marcadorDestino) map.removeLayer(marcadorDestino);
        marcadorDestino = L.marker([lat, lon]).addTo(map).bindPopup("Destino").openPopup();
        map.fitBounds([[userLatLng.lat, userLatLng.lng],[lat, lon]], {padding: [25,25]});
        if (precio) {
          mostrarResultado(
            `Distancia: ${(distancia/1000).toFixed(2)} km<br>
             <span style="color:#1976d2;">Precio del domicilio: <b>$${precio.toLocaleString('es-CO')}</b> COP</span>`
          );
        } else {
          mostrarError("La distancia entre tu ubicación y el destino supera los 8 km. No es posible calcular el precio.");
        }
      } else {
        mostrarError("No se encontró la dirección. Intenta ser más específico (ej. 'Barrio Galán, Armenia' o 'Cra 16 #24-70').");
      }
    } catch(e) {
      mostrarError("Ocurrió un error al buscar la dirección. Intenta de nuevo.");
    }
  };
});
</script>
</body>
</html>
