<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Precio de Domicilio - Armenia, Quindío</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8na8LY9N_GhuYB-ZXPeOkdg2lmV6r_ys&libraries=places,geometry"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 0; }
    header { background-color: #1976d2; color: white; padding: 15px; text-align: center; }
    #map { width: 100%; height: 350px; border-radius: 8px; margin: 20px 0; }
    .container {
      width: 420px; margin: 20px auto; background: white; padding: 25px;
      border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    input, button {
      font-size: 1rem; padding: 10px; width: 100%; margin: 12px 0;
      border-radius: 6px; border: 1px solid #bbb; box-sizing: border-box;
    }
    button {
      background-color: #1976d2; color: white; border: none; font-weight: bold;
      cursor: pointer; transition: background-color 0.3s ease;
    }
    button:hover { background-color: #115293; }
    #precio {
      margin-top: 20px; font-weight: bold; text-align: center; font-size: 1.2rem;
      background-color: #e3f2fd; color: #0d47a1; padding: 12px; border-radius: 8px;
    }
    #error { margin-top: 12px; color: #b71c1c; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>Calcula el precio de tu domicilio</h1>
    <p>Solo para envíos dentro de Armenia, Quindío, Colombia</p>
  </header>
  <div class="container">
    <div id="map"></div>
    <input id="destino" type="text" placeholder="Ingresa la dirección de destino" autocomplete="off" />
    <button onclick="calcularPrecio()">Calcular Precio</button>
    <p id="precio"></p>
    <p id="error"></p>
  </div>
  <script>
    // Límites aproximados de Armenia, Quindío
    const LIMITE = {
      norte: 4.5915,
      sur: 4.5133,
      este: -75.5948,
      oeste: -75.6810
    };
    let map, origen, autocomplete, marcadorOrigen, marcadorDestino;

    function estaDentroDeArmenia(coord) {
      return (
        coord.lat() <= LIMITE.norte &&
        coord.lat() >= LIMITE.sur &&
        coord.lng() >= LIMITE.oeste &&
        coord.lng() <= LIMITE.este
      );
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: { lat: 4.535, lng: -75.6757 } // Centro Armenia
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            origen = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            if (!estaDentroDeArmenia(origen)) {
              mostrarError('Tu ubicación está fuera de Armenia, Quindío. No se puede calcular el precio.');
              origen = null;
              return;
            }
            map.setCenter(origen);
            marcadorOrigen = new google.maps.Marker({
              position: origen,
              map: map,
              label: 'Origen',
              icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            });
          },
          () => {
            mostrarError('Permiso de ubicación denegado. No se puede calcular el precio sin ubicación.');
            origen = null;
          }
        );
      } else {
        mostrarError('Geolocalización no soportada por tu navegador.');
        origen = null;
      }

      autocomplete = new google.maps.places.Autocomplete(document.getElementById('destino'), {
        componentRestrictions: { country: 'co' },
        fields: ['geometry', 'formatted_address', 'name'],
      });
      autocomplete.addListener('place_changed', () => {
        limpiarError();
      });
    }

    function mostrarError(msg) {
      document.getElementById('error').textContent = msg;
      document.getElementById('precio').textContent = '';
    }
    function limpiarError() {
      document.getElementById('error').textContent = '';
    }

    function calcularPrecio() {
      limpiarError();
      if (!origen) {
        mostrarError('Por favor permite el acceso a tu ubicación.');
        return;
      }
      const place = autocomplete.getPlace();
      if (!place || !place.geometry) {
        const geocoder = new google.maps.Geocoder();
        const direccion = document.getElementById('destino').value;
        if (!direccion) {
          mostrarError('Por favor ingresa una dirección de destino.');
          return;
        }
        geocoder.geocode({ address: direccion + ', Armenia, Quindío, Colombia' }, (results, status) => {
          if (status === 'OK' && results[0]) {
            procesarDestino(results[0].geometry.location);
          } else {
            mostrarError('No se encontró la dirección ingresada dentro de Armenia, Quindío.');
          }
        });
      } else {
        procesarDestino(place.geometry.location);
      }
    }

    function procesarDestino(destinoCoord) {
      if (!estaDentroDeArmenia(destinoCoord)) {
        mostrarError('La dirección destino está fuera de Armenia, Quindío. No se puede calcular el precio.');
        return;
      }
      if (marcadorDestino) marcadorDestino.setMap(null);
      marcadorDestino = new google.maps.Marker({
        position: destinoCoord,
        map: map,
        label: 'Destino',
        icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
      });
      map.panTo(destinoCoord);

      const distanciaMetros = google.maps.geometry.spherical.computeDistanceBetween(origen, destinoCoord);

      let precio;
      if (distanciaMetros <= 700) precio = 5000;
      else if (distanciaMetros <= 2500) precio = 6000;
      else if (distanciaMetros <= 6000) precio = 7000;
      else if (distanciaMetros <= 7000) precio = 8000;
      else {
        mostrarError('La distancia es mayor a 7 km. No se puede calcular el precio.');
        return;
      }

      document.getElementById('precio').textContent =
        'Precio del domicilio: $' + precio.toLocaleString('es-CO') + ' COP';
      limpiarError();
    }

    window.onload = initMap;
  </script>
</body>
</html>
